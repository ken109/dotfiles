#!/usr/bin/env bash

set -eu

USER="${USER:-$(whoami)}"

# Load utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/utils.sh"

OS="$(uname -s)"

# --------------------------------------------------------------------------------------------------
#  Helper Functions
# --------------------------------------------------------------------------------------------------

load_brew() {
  if [ "$OS" = "Darwin" ]; then
    if [ -f "/opt/homebrew/bin/brew" ]; then
      eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [ -f "/usr/local/bin/brew" ]; then
      eval "$(/usr/local/bin/brew shellenv)"
    fi
  elif [ "$OS" = "Linux" ]; then
    if [ -d "/home/linuxbrew/.linuxbrew" ]; then
      eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    elif [ -d "$HOME/.linuxbrew" ]; then
      eval "$("$HOME/.linuxbrew/bin/brew" shellenv)"
    fi
  fi
}

# --------------------------------------------------------------------------------------------------
#  Installation Functions
# --------------------------------------------------------------------------------------------------

install_system_dependencies() {
  if [ "$OS" = "Linux" ]; then
    e_section "System Dependencies"
    e_header "Installing apt packages..."
    export DEBIAN_FRONTEND=noninteractive
    
    # Dependencies for Homebrew and basic build tools
    sudo apt-get update
    sudo apt-get install -y build-essential procps curl file git
    
    # Install zsh if not present
    sudo apt-get install -y zsh
    
    e_done "System dependencies installed"
  fi
}

install_homebrew() {
  e_section "Homebrew Setup"
  if ! has_command brew; then
    e_header "Installing Homebrew..."
    # Set CI=1 to avoid interactive prompt
    CI=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
    
    load_brew
    e_done "Homebrew installed"
  else
    load_brew
    e_header "Homebrew already installed"
  fi
}

install_packages() {
  e_section "Package Installation"
  e_header "Installing packages via Homebrew..."
  
  # Update brew
  brew update

  # Common tools list
  local formulas=(
    asdf
    bat
    curl
    fd
    fzf
    gdu
    ghq
    git
    git-delta
    eza
    lazygit
    neovim
    ripgrep
    sheldon
    starship
    tmux
    wget
    zsh
  )
  
  # OS specific additions
  if [ "$OS" = "Darwin" ]; then
    formulas+=(
      gpg
      gawk
      translate-shell
      git-flow-avh
      trash
    )
  elif [ "$OS" = "Linux" ]; then
    formulas+=(
      gcc
      gettext
    )
  fi

  brew install "${formulas[@]}"
  
  # Casks for macOS
  if [ "$OS" = "Darwin" ]; then
    e_header "Installing Casks..."
    brew tap homebrew/cask-fonts
    brew install --cask font-hack-nerd-font font-cica
  fi

  # Setup fzf
  if [ -f "$(brew --prefix)/opt/fzf/install" ]; then
    "$(brew --prefix)/opt/fzf/install" --all --no-bash --no-fish
  fi
  
  e_done "Packages installed"
}

# --------------------------------------------------------------------------------------------------
#  Configuration Functions
# --------------------------------------------------------------------------------------------------

configure_shell() {
  e_section "Shell Configuration"
  e_header "Configuring zsh..."
  
  local zsh_path
  zsh_path="$(brew --prefix)/bin/zsh"
  
  if [ ! -x "$zsh_path" ]; then
    e_warning "Homebrew zsh not found, falling back to system zsh"
    if [ -x "/bin/zsh" ]; then zsh_path="/bin/zsh"; fi
    if [ -x "/usr/bin/zsh" ]; then zsh_path="/usr/bin/zsh"; fi
  fi

  # Add to /etc/shells if not present
  if ! grep -q "$zsh_path" /etc/shells; then
    e_header "Adding $zsh_path to /etc/shells..."
    echo "$zsh_path" | sudo tee -a /etc/shells >/dev/null
  fi

  # Change shell
  if [ "$SHELL" != "$zsh_path" ]; then
    e_header "Changing shell to $zsh_path..."
    sudo chsh -s "$zsh_path" "$USER"
  fi
  
  e_done "Shell configured"
}

configure_asdf() {
  e_section "Tool Configuration"
  e_header "Configuring asdf..."
  
  # Source asdf
  if [ -f "$(brew --prefix asdf)/libexec/asdf.sh" ]; then
    source "$(brew --prefix asdf)/libexec/asdf.sh"
  else
    e_warning "asdf script not found, skipping configuration"
    return
  fi
  
  e_done "asdf configured"
}

configure_ghq() {
  e_header "Configuring ghq..."
  git config --global ghq.root ~/.ghq
  e_done "ghq configured"
}

configure_tpm() {
  e_header "Configuring tpm..."
  if [ ! -d "$HOME/.tmux/plugins/tpm" ]; then
    git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
    e_done "tpm installed"
  else
    e_header "tpm already installed"
  fi
}

# --------------------------------------------------------------------------------------------------
#  Main Logic
# --------------------------------------------------------------------------------------------------

main() {
  e_section "Setup Start"
  e_header "Starting setup for $OS..."

  if [ "$OS" = "Linux" ]; then
    install_system_dependencies
  fi
  
  install_homebrew
  install_packages
  
  configure_shell
  configure_asdf
  configure_ghq
  configure_tpm
  
  # Deploy dotfiles
  if [ -f "$SCRIPT_DIR/deploy" ]; then
    "$SCRIPT_DIR/deploy"
  else
    e_error "Deploy script not found!"
  fi

  e_section "Complete"
  e_done "All setup tasks completed successfully!"
}

main
